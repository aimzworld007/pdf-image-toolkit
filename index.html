<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF & Image Toolkit Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
        }

        html.dark {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --accent-hover: #3b82f6; /* blue-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom styles for UI elements */
        .main-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .tool-card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        
        html.dark .tool-card:hover {
             box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.15);
        }
        
        .pro-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        /* Cropper.js specific dark mode styles */
        html.dark .cropper-view-box {
            outline-color: var(--accent-color);
        }
        html.dark .cropper-face, html.dark .cropper-line, html.dark .cropper-point {
            background-color: var(--accent-color);
            opacity: 1;
        }
        .img-container {
            background-color: var(--bg-primary);
        }
        
        /* Style for range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }
        
        .suggestions-container {
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .suggestion-card {
            display: block;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            background-color: var(--bg-primary);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            text-align: left;
        }
        .suggestion-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-color);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

    </style>
</head>
<body class="min-h-screen">

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold">PDF & Image <span class="text-[var(--accent-color)]">Toolkit</span></h1>
                <p class="text-md text-[var(--text-secondary)] mt-1">Your one-stop solution for media manipulation.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--border-color)] transition-colors">
                <!-- Sun Icon -->
                <svg id="theme-icon-light" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <!-- Moon Icon -->
                <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>

        <!-- Main Content Area -->
        <main id="content-area" class="main-container p-6 rounded-2xl shadow-lg min-h-[60vh]">
            <!-- Tool Selection Grid (Visible by default) -->
            <div id="tool-selection">
                <!-- Official Tools -->
                <section class="mb-8">
                    <h2 class="text-2xl font-bold mb-4 border-b-2 border-[var(--border-color)] pb-2">Official Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <a href="https://iaco.netlify.app" target="_blank" rel="noopener noreferrer" class="tool-card block">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.745 3.745 0 013.296-1.043A3.745 3.745 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.745 3.745 0 011.043 3.296A3.745 3.745 0 0121 12z" />
                                </svg>
                                <h3 class="text-xl font-semibold">EID Verification</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Verify photo compliance for Emirates ID (ICA UAE PASS).</p>
                            </div>
                        </a>
                        <a href="https://icophoto.netlify.app" target="_blank" rel="noopener noreferrer" class="tool-card block">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
                                </svg>
                                <h3 class="text-xl font-semibold">IACO Photo Verify</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Verify your photo for official submissions.</p>
                            </div>
                        </a>
                    </div>
                </section>
                <!-- PDF Tools -->
                <section>
                    <h2 class="text-2xl font-bold mb-4 border-b-2 border-[var(--border-color)] pb-2">PDF Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="tool-card" data-tool="combine-pdf">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                <h3 class="text-xl font-semibold">Combine PDFs</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Merge multiple PDF files into one with previews.</p>
                            </div>
                        </div>
                        <div class="tool-card relative" data-tool="pdf-to-jpg">
                            <div class="p-6 cursor-pointer">
                                <span class="pro-badge">Pro</span>
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <h3 class="text-xl font-semibold">PDF to JPG</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Fast, server-side PDF page extraction to JPGs.</p>
                            </div>
                        </div>
                        <div class="tool-card relative" data-tool="compress-pdf">
                            <div class="p-6 cursor-pointer">
                                <span class="pro-badge">Pro</span>
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l7.5-5.5L17 8z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 10v11h11" /></svg>
                                <h3 class="text-xl font-semibold">Compress PDF</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Reduce PDF file size using server-side power.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Image Tools -->
                <section class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 border-b-2 border-[var(--border-color)] pb-2">Image Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="tool-card relative" data-tool="remove-bg">
                            <div class="p-6 cursor-pointer">
                                <span class="pro-badge">Pro</span>
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m-3-1l-3-1m3 1v5.25c0 .621-.504 1.125-1.125 1.125h-4.5c-.621 0-1.125-.504-1.125-1.125V8.25m-4.5 0l4.5-1.636M6.75 3l1.5.545m0 6.205l-3 1m3-1l3-1m-3 1V3.545" /></svg>
                                <h3 class="text-xl font-semibold">Remove Background</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Automatically remove the background from any image.</p>
                            </div>
                        </div>
                        <div class="tool-card relative" data-tool="compress-jpg">
                             <div class="p-6 cursor-pointer">
                                <span class="pro-badge">Pro</span>
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5 5" /></svg>
                                <h3 class="text-xl font-semibold">Compress JPG</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Advanced JPG compression using server-side power.</p>
                            </div>
                        </div>
                        <div class="tool-card" data-tool="crop-image">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19M4.879 4.879L9.879 9.879M14.121 9.879L9.879 14.121M19 4.879L14.121 9.879M12 21a9 9 0 110-18 9 9 0 010 18z" transform="rotate(45 12 12)" /></svg>
                                <h3 class="text-xl font-semibold">Image Cropper</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Crop and cut your images with an easy-to-use interface.</p>
                            </div>
                        </div>
                        <div class="tool-card" data-tool="resize-image">
                             <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5 5" /></svg>
                                <h3 class="text-xl font-semibold">Image Resizer</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Change the dimensions of your images quickly.</p>
                            </div>
                        </div>
                        <div class="tool-card" data-tool="convert-image" data-target-format="png" data-accept="image/jpeg">
                             <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                <h3 class="text-xl font-semibold">JPG to PNG</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Convert your JPG images to PNG format.</p>
                            </div>
                        </div>
                        <div class="tool-card" data-tool="convert-image" data-target-format="jpeg" data-accept="image/png">
                             <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                <h3 class="text-xl font-semibold">PNG to JPG</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Convert your PNG images to JPG format.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Combined Tools -->
                <section class="mt-8">
                    <h2 class="text-2xl font-bold mb-4 border-b-2 border-[var(--border-color)] pb-2">Combined Tools</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="tool-card" data-tool="jpg-to-pdf">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <h3 class="text-xl font-semibold">JPG to PDF</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Convert a single JPG image into a PDF document.</p>
                            </div>
                        </div>
                         <div class="tool-card" data-tool="images-to-pdf">
                            <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12h.01M8 12h.01M16 12h.01" /></svg>
                                <h3 class="text-xl font-semibold">Images to PDF</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Combine multiple images into a single PDF file.</p>
                            </div>
                        </div>
                        <div class="tool-card" data-tool="merge-images">
                             <div class="p-6 cursor-pointer">
                                <svg class="h-10 w-10 mb-3 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                                <h3 class="text-xl font-semibold">Merge Images</h3>
                                <p class="text-sm text-[var(--text-secondary)] mt-1">Join two images together, vertically or horizontally.</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Active Tool Area (Hidden by default) -->
            <div id="active-tool-area" class="hidden"></div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-[var(--text-secondary)] text-sm">
            <p>Application Developed By <a href="https://Ainulislam.info" target="_blank" rel="noopener noreferrer" class="font-semibold text-[var(--accent-color)] hover:underline">Ainulislam</a></p>
        </footer>

        <!-- Loading Spinner -->
        <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-400"></div>
                <p id="loader-text" class="text-white text-lg mt-4">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Templates for each tool will be placed here -->
    <template id="template-jpg-to-pdf">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4 text-[var(--text-primary)]">JPG to PDF Converter</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Upload a JPG image to convert it into a PDF document.</p>
            <input type="file" id="jpgFile" accept="image/jpeg" class="file-input">
            <button id="convertToPdfBtn" class="action-btn">Convert to PDF</button>
            <div id="jpg-to-pdf-output" class="output-area"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="images-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">Images to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Combine multiple images.</p></a>
                    <a href="#" class="suggestion-card" data-tool="compress-pdf"><h4 class="font-bold text-[var(--text-primary)]">Compress PDF</h4><p class="text-sm text-[var(--text-secondary)]">Reduce PDF file size.</p></a>
                    <a href="#" class="suggestion-card" data-tool="convert-image" data-target-format="jpeg" data-accept="image/png"><h4 class="font-bold text-[var(--text-primary)]">PNG to JPG</h4><p class="text-sm text-[var(--text-secondary)]">Convert image formats.</p></a>
                </div>
            </div>
        </div>
    </template>

    <template id="template-pdf-to-jpg">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4 text-[var(--text-primary)]">PDF to JPG Converter (Pro)</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Upload a PDF file to convert its pages into high-quality JPG images using our server.</p>
            <input type="file" id="pdfFile" accept="application/pdf" class="file-input">
            <button id="convertToJpgBtn" class="action-btn">Convert to JPG</button>
            <div id="pdf-to-jpg-output" class="output-area grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="combine-pdf"><h4 class="font-bold text-[var(--text-primary)]">Combine PDFs</h4><p class="text-sm text-[var(--text-secondary)]">Merge multiple PDFs.</p></a>
                    <a href="#" class="suggestion-card" data-tool="compress-jpg"><h4 class="font-bold text-[var(--text-primary)]">Compress JPG</h4><p class="text-sm text-[var(--text-secondary)]">Shrink image file sizes.</p></a>
                    <a href="#" class="suggestion-card" data-tool="crop-image"><h4 class="font-bold text-[var(--text-primary)]">Image Cropper</h4><p class="text-sm text-[var(--text-secondary)]">Crop your new images.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-merge-images">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Merge Images</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Select two images to merge them vertically or horizontally.</p>
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="img1" class="block mb-2 font-medium">Image 1:</label>
                    <input type="file" id="img1" accept="image/*" class="file-input">
                </div>
                <div>
                    <label for="img2" class="block mb-2 font-medium">Image 2:</label>
                    <input type="file" id="img2" accept="image/*" class="file-input">
                </div>
            </div>
            <div class="flex items-center gap-4 mb-4">
                <label class="font-medium">Merge Direction:</label>
                <select id="mergeDirection" class="p-2 border rounded-md bg-[var(--bg-primary)] border-[var(--border-color)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
                    <option value="vertical">Vertical</option>
                    <option value="horizontal">Horizontal</option>
                </select>
            </div>
            <button id="mergeBtn" class="action-btn">Merge Images</button>
            <div id="merge-output" class="output-area"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="crop-image"><h4 class="font-bold text-[var(--text-primary)]">Image Cropper</h4><p class="text-sm text-[var(--text-secondary)]">Crop images before merging.</p></a>
                    <a href="#" class="suggestion-card" data-tool="resize-image"><h4 class="font-bold text-[var(--text-primary)]">Image Resizer</h4><p class="text-sm text-[var(--text-secondary)]">Resize images to match.</p></a>
                    <a href="#" class="suggestion-card" data-tool="images-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">Images to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Save result to a PDF.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-convert-image">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Image Format Converter</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Convert images between JPG and PNG formats.</p>
            <input type="file" id="convertFile" accept="image/jpeg,image/png" class="file-input">
            <div class="flex items-center gap-4 my-4">
                <label class="font-medium">Convert To:</label>
                <select id="convertFormat" class="p-2 border rounded-md bg-[var(--bg-primary)] border-[var(--border-color)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
                    <option value="png">PNG</option>
                    <option value="jpeg">JPG</option>
                </select>
            </div>
            <button id="convertImgBtn" class="action-btn">Convert Image</button>
            <div id="convert-output" class="output-area"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="compress-jpg"><h4 class="font-bold text-[var(--text-primary)]">Compress JPG</h4><p class="text-sm text-[var(--text-secondary)]">Reduce file size after.</p></a>
                    <a href="#" class="suggestion-card" data-tool="remove-bg"><h4 class="font-bold text-[var(--text-primary)]">Remove Background</h4><p class="text-sm text-[var(--text-secondary)]">Get a transparent BG.</p></a>
                    <a href="#" class="suggestion-card" data-tool="jpg-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">JPG to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Convert JPGs to PDF.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-images-to-pdf">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Combine Images into PDF</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Select multiple images to combine. Drag and drop to reorder.</p>
            <input type="file" id="multipleImages" accept="image/*" multiple class="file-input">
            <button id="combineToPdfBtn" class="action-btn">Combine to PDF</button>
            <div id="image-preview-list" class="output-area mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="combine-pdf"><h4 class="font-bold text-[var(--text-primary)]">Combine PDFs</h4><p class="text-sm text-[var(--text-secondary)]">Merge with other PDFs.</p></a>
                    <a href="#" class="suggestion-card" data-tool="compress-pdf"><h4 class="font-bold text-[var(--text-primary)]">Compress PDF</h4><p class="text-sm text-[var(--text-secondary)]">Reduce the final PDF size.</p></a>
                    <a href="#" class="suggestion-card" data-tool="resize-image"><h4 class="font-bold text-[var(--text-primary)]">Image Resizer</h4><p class="text-sm text-[var(--text-secondary)]">Standardize image sizes.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-crop-image">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Image Cropper</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Upload an image to crop it. Use the selection box to define the crop area.</p>
            <input type="file" id="cropFile" accept="image/*" class="file-input">
            <div class="flex flex-col md:flex-row gap-6 items-start">
                <div class="w-full md:w-2/3">
                    <div class="img-container rounded-lg overflow-hidden"><img id="imageToCrop" style="display: block; max-width: 100%;"></div>
                </div>
                 <div class="w-full md:w-1/3 flex flex-col items-center">
                    <p class="font-medium mb-2">Preview</p>
                    <div id="crop-preview" class="w-[150px] h-[150px] overflow-hidden rounded-lg border-2 border-dashed border-[var(--border-color)]"></div>
                </div>
            </div>
            <button id="cropBtn" class="action-btn mt-4">Crop & Download</button>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="resize-image"><h4 class="font-bold text-[var(--text-primary)]">Image Resizer</h4><p class="text-sm text-[var(--text-secondary)]">Resize after cropping.</p></a>
                    <a href="#" class="suggestion-card" data-tool="compress-jpg"><h4 class="font-bold text-[var(--text-primary)]">Compress JPG</h4><p class="text-sm text-[var(--text-secondary)]">Compress the cropped image.</p></a>
                    <a href="#" class="suggestion-card" data-tool="remove-bg"><h4 class="font-bold text-[var(--text-primary)]">Remove Background</h4><p class="text-sm text-[var(--text-secondary)]">Remove the BG.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-resize-image">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Image Resizer</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Upload an image and specify new dimensions to resize it.</p>
            <input type="file" id="resizeFile" accept="image/*" class="file-input">
            <div class="flex flex-wrap gap-4 my-4 items-center">
                <div>
                    <label for="newWidth" class="font-medium">Width:</label>
                    <input type="number" id="newWidth" placeholder="800" class="p-2 border rounded-md w-32 bg-[var(--bg-primary)] border-[var(--border-color)]">
                </div>
                <div>
                    <label for="newHeight" class="font-medium">Height:</label>
                    <input type="number" id="newHeight" placeholder="600" class="p-2 border rounded-md w-32 bg-[var(--bg-primary)] border-[var(--border-color)]">
                </div>
                <div class="flex items-center pt-5">
                    <input type="checkbox" id="aspectRatio" class="h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)]" checked>
                    <label for="aspectRatio" class="ml-2">Maintain Aspect Ratio</label>
                </div>
            </div>
            <button id="resizeBtn" class="action-btn">Resize & Download</button>
            <div id="resize-output" class="output-area"></div>
             <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="crop-image"><h4 class="font-bold text-[var(--text-primary)]">Image Cropper</h4><p class="text-sm text-[var(--text-secondary)]">Crop before resizing.</p></a>
                    <a href="#" class="suggestion-card" data-tool="compress-jpg"><h4 class="font-bold text-[var(--text-primary)]">Compress JPG</h4><p class="text-sm text-[var(--text-secondary)]">Compress the resized image.</p></a>
                    <a href="#" class="suggestion-card" data-tool="merge-images"><h4 class="font-bold text-[var(--text-primary)]">Merge Images</h4><p class="text-sm text-[var(--text-secondary)]">Combine with another image.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-compress-jpg">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Compress JPG (Pro)</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Reduce JPG file size using advanced server-side compression for the best results.</p>
            <input type="file" id="compressJpgFile" accept="image/jpeg" class="file-input">
            <div class="my-4">
                <label for="qualitySlider" class="font-medium">Quality: <span id="qualityValue">80</span></label>
                <input type="range" id="qualitySlider" min="10" max="100" step="5" value="80" class="w-full mt-2">
            </div>
             <div id="compress-jpg-output" class="output-area"></div>
            <button id="compressJpgBtn" class="action-btn mt-4">Compress & Download</button>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="resize-image"><h4 class="font-bold text-[var(--text-primary)]">Image Resizer</h4><p class="text-sm text-[var(--text-secondary)]">Change dimensions.</p></a>
                    <a href="#" class="suggestion-card" data-tool="images-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">Images to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Save images into a PDF.</p></a>
                    <a href="#" class="suggestion-card" data-tool="remove-bg"><h4 class="font-bold text-[var(--text-primary)]">Remove Background</h4><p class="text-sm text-[var(--text-secondary)]">Make background transparent.</p></a>
                </div>
            </div>
        </div>
    </template>

    <template id="template-compress-pdf">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Compress PDF (Pro)</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Reduce the file size of your PDF using our powerful server-side tool. Best for PDFs with many images.</p>
            <input type="file" id="compressPdfFile" accept="application/pdf" class="file-input">
            <div id="compress-pdf-output" class="output-area"></div>
            <button id="compressPdfBtn" class="action-btn mt-4">Compress PDF</button>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="combine-pdf"><h4 class="font-bold text-[var(--text-primary)]">Combine PDFs</h4><p class="text-sm text-[var(--text-secondary)]">Merge with other PDFs.</p></a>
                    <a href="#" class="suggestion-card" data-tool="pdf-to-jpg"><h4 class="font-bold text-[var(--text-primary)]">PDF to JPG</h4><p class="text-sm text-[var(--text-secondary)]">Extract pages as images.</p></a>
                    <a href="#" class="suggestion-card" data-tool="jpg-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">JPG to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Create a new PDF from a JPG.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-combine-pdf">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Combine PDFs</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Add multiple PDF files, reorder them, and then merge them into a single document.</p>
            <input type="file" id="multiplePdfs" accept="application/pdf" multiple class="hidden">
            <button id="addPdfBtn" class="action-btn mb-4">Add PDF(s)</button>
            <div id="pdf-preview-list" class="output-area mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <button id="combinePdfBtn" class="action-btn mt-4">Combine All PDFs in List</button>
            <div id="combine-pdf-output" class="output-area mt-4"></div>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="compress-pdf"><h4 class="font-bold text-[var(--text-primary)]">Compress PDF</h4><p class="text-sm text-[var(--text-secondary)]">Reduce final file size.</p></a>
                    <a href="#" class="suggestion-card" data-tool="pdf-to-jpg"><h4 class="font-bold text-[var(--text-primary)]">PDF to JPG</h4><p class="text-sm text-[var(--text-secondary)]">Extract all pages.</p></a>
                    <a href="#" class="suggestion-card" data-tool="images-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">Images to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Combine images into a PDF.</p></a>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-remove-bg">
        <div class="tool-content">
            <h2 class="text-2xl font-semibold mb-4">Remove Background (Pro)</h2>
            <p class="mb-4 text-[var(--text-secondary)]">Upload an image and our server will automatically remove the background.</p>
            <input type="file" id="removeBgFile" accept="image/png, image/jpeg" class="file-input">
            <div id="remove-bg-output" class="output-area"></div>
            <button id="removeBgBtn" class="action-btn mt-4">Remove Background</button>
            <div class="suggestions-container">
                <h3 class="text-lg font-semibold mb-3 text-center text-[var(--text-secondary)]">You might also like...</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="#" class="suggestion-card" data-tool="compress-jpg"><h4 class="font-bold text-[var(--text-primary)]">Compress JPG</h4><p class="text-sm text-[var(--text-secondary)]">Reduce image file size.</p></a>
                    <a href="#" class="suggestion-card" data-tool="crop-image"><h4 class="font-bold text-[var(--text-primary)]">Image Cropper</h4><p class="text-sm text-[var(--text-secondary)]">Crop the subject.</p></a>
                    <a href="#" class="suggestion-card" data-tool="images-to-pdf"><h4 class="font-bold text-[var(--text-primary)]">Images to PDF</h4><p class="text-sm text-[var(--text-secondary)]">Save image to a PDF.</p></a>
                </div>
            </div>
        </div>
    </template>


    <script>
        // Set global worker for pdf.js (used for client-side previews)
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const { PDFDocument } = PDFLib;

            // --- UI & THEME MANAGEMENT ---
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const html = document.documentElement;

            const toolSelection = document.getElementById('tool-selection');
            const activeToolArea = document.getElementById('active-tool-area');
            const toolCards = document.querySelectorAll('.tool-card');
            const loader = document.getElementById('loader');
            
            let cropper = null;
            let originalImageRatio = 1;
            let imageFilesOrder = [];
            let pdfFilesOrder = [];

            // Theme switching logic
            const applyTheme = (isDark) => {
                html.classList.toggle('dark', isDark);
                lightIcon.classList.toggle('hidden', isDark);
                darkIcon.classList.toggle('hidden', !isDark);
            };

            themeToggle.addEventListener('click', () => {
                const isDark = !html.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                applyTheme(isDark);
            });
            
            // Apply saved theme or system preference on load
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme === 'dark' || (!savedTheme && systemPrefersDark));

            
            // --- NAVIGATION LOGIC ---
            const showToolSelection = () => {
                toolSelection.classList.remove('hidden');
                activeToolArea.classList.add('hidden');
                activeToolArea.innerHTML = '';
                if(cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            };
            
            const switchTool = (toolId, dataset = {}) => {
                const template = document.getElementById(`template-${toolId}`);
                if (template) {
                    toolSelection.classList.add('hidden');
                    activeToolArea.classList.remove('hidden');
                    
                    const backButton = document.createElement('button');
                    backButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg> Back to Tools`;
                    backButton.className = 'back-btn mb-6 flex items-center font-semibold text-[var(--text-secondary)] hover:text-[var(--accent-color)] transition-colors';
                    backButton.onclick = showToolSelection;

                    const toolContent = template.content.cloneNode(true);
                    activeToolArea.innerHTML = ''; // Clear previous content
                    activeToolArea.appendChild(backButton);
                    activeToolArea.appendChild(toolContent);
                    
                    addToolEventListeners(toolId);
                    
                    // Pre-configure tools based on data attributes
                    if (toolId === 'convert-image' && dataset.targetFormat) {
                        const select = activeToolArea.querySelector('#convertFormat');
                        const fileInput = activeToolArea.querySelector('#convertFile');
                        if (select) select.value = dataset.targetFormat;
                        if (fileInput && dataset.accept) fileInput.accept = dataset.accept;
                    }
                }
            };
            
            toolCards.forEach(card => {
                card.addEventListener('click', () => switchTool(card.dataset.tool, card.dataset));
            });
            
            // --- UTILITY FUNCTIONS ---
            const showLoader = (show, text = 'Processing...') => { 
                document.getElementById('loader-text').textContent = text;
                loader.style.display = show ? 'flex' : 'none'; 
            };
            
            const formatBytes = (bytes, decimals = 2) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            };

            const createDownloadLink = (href, download, text, targetElement) => {
                targetElement.innerHTML = ''; // Clear previous content
                const a = document.createElement('a');
                a.href = href;
                a.download = download;
                a.textContent = text;
                a.className = 'download-link';
                targetElement.appendChild(a);
            };

            const loadImage = (src) => new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
            
            const fileToDataUrl = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            
            // --- EVENT LISTENERS ---
            
            // Main listener for tool selection
            function addToolEventListeners(toolId) {
                const getEl = (id) => activeToolArea.querySelector('#' + id);

                switch (toolId) {
                    case 'jpg-to-pdf': getEl('convertToPdfBtn').addEventListener('click', handleJpgToPdf); break;
                    case 'pdf-to-jpg': getEl('convertToJpgBtn').addEventListener('click', handlePdfToJpg); break;
                    case 'merge-images': getEl('mergeBtn').addEventListener('click', handleMergeImages); break;
                    case 'convert-image': getEl('convertImgBtn').addEventListener('click', handleConvertImage); break;
                    case 'images-to-pdf':
                        getEl('combineToPdfBtn').addEventListener('click', handleImagesToPdf);
                        getEl('multipleImages').addEventListener('change', handleImagePreviews);
                        break;
                    case 'crop-image':
                        getEl('cropFile').addEventListener('change', handleCropFileChange);
                        getEl('cropBtn').addEventListener('click', handleCropImage);
                        break;
                    case 'resize-image':
                        const resizeFileInput = getEl('resizeFile');
                        resizeFileInput.addEventListener('change', () => {
                            const file = resizeFileInput.files[0]; if (!file) return;
                            const reader = new FileReader();
                            reader.onload = e => {
                                const img = new Image();
                                img.onload = () => {
                                   getEl('newWidth').value = img.width; getEl('newHeight').value = img.height;
                                   originalImageRatio = img.width / img.height;
                                };
                                img.src = e.target.result;
                            }
                            reader.readAsDataURL(file);
                        });
                        getEl('newWidth').addEventListener('input', () => handleAspectRatio('width'));
                        getEl('newHeight').addEventListener('input', () => handleAspectRatio('height'));
                        getEl('resizeBtn').addEventListener('click', handleResizeImage);
                        break;
                    case 'compress-jpg':
                        getEl('qualitySlider').addEventListener('input', (e) => {
                            getEl('qualityValue').textContent = e.target.value;
                        });
                        getEl('compressJpgBtn').addEventListener('click', handleCompressJpg);
                        break;
                    case 'compress-pdf': getEl('compressPdfBtn').addEventListener('click', handleCompressPdf); break;
                    case 'combine-pdf':
                        getEl('addPdfBtn').addEventListener('click', () => getEl('multiplePdfs').click());
                        getEl('combinePdfBtn').addEventListener('click', handleCombinePdfs);
                        getEl('multiplePdfs').addEventListener('change', handlePdfPreviews);
                        break;
                    case 'remove-bg': getEl('removeBgBtn').addEventListener('click', handleRemoveBg); break;
                }
            }
            
            // Delegated event listener for suggested tools
            activeToolArea.addEventListener('click', (e) => {
                const suggestionCard = e.target.closest('.suggestion-card');
                if (suggestionCard) {
                    e.preventDefault();
                    const toolId = suggestionCard.dataset.tool;
                    const originalToolCard = document.querySelector(`.tool-card[data-tool="${toolId}"]`);
                    const dataset = originalToolCard ? originalToolCard.dataset : {};
                    switchTool(toolId, dataset);
                }
            });
        
            // --- SERVER-SIDE TOOL IMPLEMENTATIONS ---
            
            // PDF to JPG (Server-Side)
            async function handlePdfToJpg() {
                const fileInput = activeToolArea.querySelector('#pdfFile');
                const outputDiv = activeToolArea.querySelector('#pdf-to-jpg-output');
                if (fileInput.files.length === 0) {
                    alert('Please select a PDF file.');
                    return;
                }
                const file = fileInput.files[0];
                showLoader(true, 'Extracting pages on server...');
                outputDiv.innerHTML = '';

                try {
                    const pdfDataUrl = await fileToDataUrl(file);
                    const response = await fetch('/.netlify/functions/pdf-to-jpg', {
                        method: 'POST',
                        body: JSON.stringify({ pdf: pdfDataUrl }),
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Server error');
                    }

                    const { images } = await response.json();

                    images.forEach((base64Img, index) => {
                        const a = document.createElement('a');
                        a.href = `data:image/jpeg;base64,${base64Img}`;
                        a.download = `page_${index + 1}.jpg`;
                        a.innerHTML = `<img src="${a.href}" class="w-full h-auto object-cover rounded-lg shadow-md border border-[var(--border-color)]">`;
                        outputDiv.appendChild(a);
                    });
                } catch (error) {
                    console.error('PDF to JPG Error:', error);
                    outputDiv.innerHTML = `<p class="text-red-500 col-span-full">Error: ${error.message}</p>`;
                } finally {
                    showLoader(false);
                }
            }

            // Remove Background (Server-Side)
            async function handleRemoveBg() {
                const fileInput = activeToolArea.querySelector('#removeBgFile');
                const outputDiv = activeToolArea.querySelector('#remove-bg-output');
                if (fileInput.files.length === 0) {
                    alert('Please select an image file.');
                    return;
                }
                const file = fileInput.files[0];
                showLoader(true, 'Removing background...');
                outputDiv.innerHTML = '';

                try {
                    const imageDataUrl = await fileToDataUrl(file);
                    const response = await fetch('/.netlify/functions/remove-bg', {
                        method: 'POST',
                        body: JSON.stringify({ image: imageDataUrl }),
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Server error');
                    }

                    const { image: resultImageB64 } = await response.json();
                    
                    const resultUrl = `data:image/png;base64,${resultImageB64}`;
                    
                    const resultHtml = `
                        <div class="flex flex-col items-center">
                            <img src="${resultUrl}" class="max-w-xs h-auto rounded-lg shadow-lg border border-[var(--border-color)]">
                        </div>
                    `;
                    outputDiv.innerHTML = resultHtml;
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = resultUrl;
                    downloadLink.download = `background-removed-${file.name.replace(/\.[^/.]+$/, "")}.png`;
                    downloadLink.textContent = 'Download Image';
                    downloadLink.className = 'download-link mt-4';
                    outputDiv.querySelector('div').appendChild(downloadLink);
                } catch (error) {
                    console.error('Background Removal Error:', error);
                    outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                } finally {
                    showLoader(false);
                }
            }
            
            // Compress JPG (Server-Side)
            async function handleCompressJpg() {
                const fileInput = activeToolArea.querySelector('#compressJpgFile');
                const quality = parseInt(activeToolArea.querySelector('#qualitySlider').value, 10);
                const outputDiv = activeToolArea.querySelector('#compress-jpg-output');

                if (fileInput.files.length === 0) {
                    alert('Please select a JPG file.');
                    return;
                }
                const file = fileInput.files[0];
                showLoader(true, 'Compressing on server...');

                try {
                    const imageDataUrl = await fileToDataUrl(file);
                    const response = await fetch('/.netlify/functions/compress-jpg', {
                        method: 'POST',
                        body: JSON.stringify({
                            image: imageDataUrl,
                            quality: quality
                        }),
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Server error');
                    }

                    const { image: compressedImageB64, newSize } = await response.json();
                    const originalSize = file.size;
                    const savings = 100 - (newSize / originalSize * 100);

                    const resultHtml = `
                        <p>Original Size: <strong>${formatBytes(originalSize)}</strong></p>
                        <p>New Size: <strong>${formatBytes(newSize)}</strong></p>
                        <p class="text-green-600 dark:text-green-400 font-bold">You saved ${savings.toFixed(1)}%!</p>
                    `;
                    outputDiv.innerHTML = resultHtml;

                    const downloadLink = document.createElement('a');
                    downloadLink.href = `data:image/jpeg;base64,${compressedImageB64}`;
                    downloadLink.download = `compressed-${file.name}`;
                    downloadLink.textContent = 'Download Compressed Image';
                    downloadLink.className = 'download-link mt-4';
                    outputDiv.appendChild(downloadLink);

                } catch (error) {
                    console.error('Compression Error:', error);
                    outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                } finally {
                    showLoader(false);
                }
            }
            
            // Compress PDF (Server-Side)
            async function handleCompressPdf() {
                const fileInput = activeToolArea.querySelector('#compressPdfFile');
                const outputDiv = activeToolArea.querySelector('#compress-pdf-output');

                if (fileInput.files.length === 0) {
                    alert('Please select a PDF file.');
                    return;
                }
                const file = fileInput.files[0];
                showLoader(true, 'Compressing on server...');

                try {
                    const pdfDataUrl = await fileToDataUrl(file);
                    const response = await fetch('/.netlify/functions/compress-pdf', {
                        method: 'POST',
                        body: JSON.stringify({ pdf: pdfDataUrl }),
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Server error');
                    }
                    
                    const { pdf: compressedPdfB64, newSize } = await response.json();
                    const originalSize = file.size;
                    const savings = 100 - (newSize / originalSize * 100);

                    const resultHtml = `
                        <p>Original Size: <strong>${formatBytes(originalSize)}</strong></p>
                        <p>New Size: <strong>${formatBytes(newSize)}</strong></p>
                        <p class="text-green-600 dark:text-green-400 font-bold">You saved ${savings.toFixed(1)}%!</p>
                    `;
                    outputDiv.innerHTML = resultHtml;
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `data:application/pdf;base64,${compressedPdfB64}`;
                    downloadLink.download = `compressed-${file.name}`;
                    downloadLink.textContent = 'Download Compressed PDF';
                    downloadLink.className = 'download-link mt-4';
                    outputDiv.appendChild(downloadLink);
                } catch (error) {
                    console.error('Compression Error:', error);
                    outputDiv.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                } finally {
                    showLoader(false);
                }
            }

            // --- ALL OTHER CLIENT-SIDE HELPER FUNCTIONS ---

            // Combine PDFs (Client-Side)
            async function handlePdfPreviews(event) {
                const previewList = activeToolArea.querySelector('#pdf-preview-list');
                const newFiles = Array.from(event.target.files);
                if (newFiles.length === 0) return;

                const startingIndex = pdfFilesOrder.length;
                pdfFilesOrder.push(...newFiles);

                for (let i = 0; i < newFiles.length; i++) {
                    const file = newFiles[i];
                    const currentIndex = startingIndex + i;
                    const div = document.createElement('div');
                    div.className = 'relative p-2 border border-[var(--border-color)] rounded-lg shadow-sm cursor-move bg-[var(--bg-secondary)]';
                    div.draggable = true;
                    div.dataset.index = currentIndex;
                    
                    const canvas = document.createElement('canvas');
                    canvas.className = 'w-full h-24 object-cover rounded-md bg-white';
                    const p = document.createElement('p');
                    p.className = 'text-xs truncate mt-1';
                    p.textContent = file.name;

                    div.appendChild(canvas);
                    div.appendChild(p);
                    previewList.appendChild(div);

                    const fileReader = new FileReader();
                    fileReader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        try {
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            const page = await pdf.getPage(1);
                            const viewport = page.getViewport({ scale: 0.5 });
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                        } catch (e) {
                            console.error("Failed to render PDF preview:", e);
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = 'var(--text-secondary)';
                            ctx.textAlign = 'center';
                            ctx.font = '12px Inter';
                            ctx.fillText('Preview N/A', canvas.width / 2, canvas.height / 2);
                        }
                    };
                    fileReader.readAsArrayBuffer(file);
                }
                
                event.target.value = ''; // Allow re-adding the same file

                let draggedItem = null;
                if (!previewList.dataset.dragInitialized) {
                    previewList.dataset.dragInitialized = 'true';
                    previewList.addEventListener('dragstart', e => { draggedItem = e.target.closest('div[draggable]'); });
                    previewList.addEventListener('dragover', e => { e.preventDefault(); const target = e.target.closest('div[draggable]'); if (target && target !== draggedItem) { const rect = target.getBoundingClientRect(); const next = (e.clientY - rect.top) / rect.height > .5; previewList.insertBefore(draggedItem, next && target.nextSibling || target); } });
                    previewList.addEventListener('drop', () => {
                        if (!draggedItem) return;
                        const newOrderElements = [...previewList.children];
                        const newFileOrder = newOrderElements.map(el => pdfFilesOrder[parseInt(el.dataset.index)]);
                        pdfFilesOrder = newFileOrder;
                        newOrderElements.forEach((el, i) => el.dataset.index = i);
                        draggedItem = null;
                    });
                }
            }
            
            async function handleCombinePdfs() {
                if (pdfFilesOrder.length < 1) { alert('Please add at least one PDF file to combine.'); return; }
                showLoader(true, "Combining PDFs...");
                
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (const pdfFile of pdfFilesOrder) {
                        const pdfBytes = await pdfFile.arrayBuffer();
                        const pdfDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });
                        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }
                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                    const outputEl = activeToolArea.querySelector('#combine-pdf-output');
                    createDownloadLink(URL.createObjectURL(blob), 'combined.pdf', 'Download Combined PDF', outputEl);
                    activeToolArea.querySelector('#pdf-preview-list').innerHTML = '';
                    pdfFilesOrder = [];
                } catch (error) {
                    console.error(error);
                    alert("An error occurred while combining PDFs. One of the files might be corrupted or protected.");
                } finally {
                    showLoader(false);
                }
            }
            
            async function handleJpgToPdf() {
                const fileInput = activeToolArea.querySelector('#jpgFile');
                if (fileInput.files.length === 0) { alert('Please select a JPG file.'); return; }
                showLoader(true);
                const jpgBytes = await fileInput.files[0].arrayBuffer();
                const pdfDoc = await PDFDocument.create();
                const jpgImage = await pdfDoc.embedJpg(jpgBytes);
                const page = pdfDoc.addPage([jpgImage.width, jpgImage.height]);
                page.drawImage(jpgImage, { x: 0, y: 0, width: jpgImage.width, height: jpgImage.height });
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                createDownloadLink(URL.createObjectURL(blob), 'converted.pdf', 'Download PDF', activeToolArea.querySelector('#jpg-to-pdf-output'));
                showLoader(false);
            }

            async function handleMergeImages() {
                const file1 = activeToolArea.querySelector('#img1').files[0];
                const file2 = activeToolArea.querySelector('#img2').files[0];
                const direction = activeToolArea.querySelector('#mergeDirection').value;
                const outputDiv = activeToolArea.querySelector('#merge-output');
                if (!file1 || !file2) { alert('Please select two images.'); return; }
                showLoader(true);
                const [img1, img2] = await Promise.all([loadImage(URL.createObjectURL(file1)), loadImage(URL.createObjectURL(file2))]);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                if (direction === 'horizontal') {
                    canvas.width = img1.width + img2.width;
                    canvas.height = Math.max(img1.height, img2.height);
                    ctx.drawImage(img1, 0, 0); ctx.drawImage(img2, img1.width, 0);
                } else {
                    canvas.width = Math.max(img1.width, img2.width);
                    canvas.height = img1.height + img2.height;
                    ctx.drawImage(img1, 0, 0); ctx.drawImage(img2, 0, img1.height);
                }
                const url = canvas.toDataURL('image/png');
                createDownloadLink(url, 'merged.png', 'Download Merged Image', outputDiv);
                outputDiv.insertAdjacentHTML('beforeend', `<img src="${url}" class="max-w-full h-auto mt-4 rounded-lg shadow-md">`);
                showLoader(false);
            }

            async function handleConvertImage() {
                const fileInput = activeToolArea.querySelector('#convertFile');
                const format = activeToolArea.querySelector('#convertFormat').value;
                const outputDiv = activeToolArea.querySelector('#convert-output');
                if (fileInput.files.length === 0) { alert('Please select an image file.'); return; }
                showLoader(true);
                const image = await loadImage(URL.createObjectURL(fileInput.files[0]));
                const canvas = document.createElement('canvas');
                canvas.width = image.width; canvas.height = image.height;
                const ctx = canvas.getContext('2d');
                if (format === 'jpeg') {
                    ctx.fillStyle = '#FFF';
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                }
                ctx.drawImage(image, 0, 0);
                const mimeType = `image/${format}`;
                createDownloadLink(canvas.toDataURL(mimeType), `converted.${format}`, `Download as ${format.toUpperCase()}`, outputDiv);
                showLoader(false);
            }
            
            function handleImagePreviews() {
                const previewList = activeToolArea.querySelector('#image-preview-list');
                const files = activeToolArea.querySelector('#multipleImages').files;
                previewList.innerHTML = '';
                imageFilesOrder = Array.from(files);
                imageFilesOrder.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'relative p-2 border border-[var(--border-color)] rounded-lg shadow-sm cursor-move bg-[var(--bg-secondary)]';
                        div.draggable = true; div.dataset.index = index;
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded-md"><p class="text-xs truncate mt-1">${file.name}</p>`;
                        previewList.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                let draggedItem = null;
                if (!previewList.dataset.dragInitialized) {
                    previewList.dataset.dragInitialized = 'true';
                    previewList.addEventListener('dragstart', e => { draggedItem = e.target.closest('div[draggable]'); });
                    previewList.addEventListener('dragover', e => { e.preventDefault(); const target = e.target.closest('div[draggable]'); if (target && target !== draggedItem) { const rect = target.getBoundingClientRect(); const next = (e.clientY - rect.top) / rect.height > .5; previewList.insertBefore(draggedItem, next && target.nextSibling || target); } });
                    previewList.addEventListener('drop', () => {
                        if (!draggedItem) return;
                        const newOrderElements = [...previewList.children];
                        const newFileOrder = newOrderElements.map(el => imageFilesOrder[parseInt(el.dataset.index)]);
                        imageFilesOrder = newFileOrder;
                        newOrderElements.forEach((el, i) => el.dataset.index = i);
                        draggedItem = null;
                    });
                }
            }
        
            async function handleImagesToPdf() {
                if (imageFilesOrder.length === 0) { alert('Please select at least one image.'); return; }
                showLoader(true);
                const pdfDoc = await PDFDocument.create();
                for (const file of imageFilesOrder) {
                    const bytes = await file.arrayBuffer();
                    let image;
                    if (file.type === 'image/jpeg') image = await pdfDoc.embedJpg(bytes);
                    else if (file.type === 'image/png') image = await pdfDoc.embedPng(bytes);
                    else continue;
                    const page = pdfDoc.addPage([image.width, image.height]);
                    page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                }
                const pdfBytes = await pdfDoc.save();
                createDownloadLink(URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' })), 'combined_images.pdf', 'Download Combined PDF', activeToolArea.querySelector('#image-preview-list'));
                showLoader(false);
            }

            function handleCropFileChange(event) {
                const files = event.target.files;
                if (files && files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const imageElement = activeToolArea.querySelector('#imageToCrop');
                        imageElement.src = e.target.result;
                        if (cropper) cropper.replace(e.target.result);
                        else cropper = new Cropper(imageElement, { aspectRatio: 1, viewMode: 1, preview: activeToolArea.querySelector('#crop-preview') });
                    };
                    reader.readAsDataURL(files[0]);
                }
            }

            function handleCropImage() {
                if (!cropper) { alert('Please upload an image first.'); return; }
                cropper.getCroppedCanvas().toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'cropped.png'; a.click();
                    URL.revokeObjectURL(url);
                });
            }

            function handleAspectRatio(changedInput) {
                const widthInput = activeToolArea.querySelector('#newWidth');
                const heightInput = activeToolArea.querySelector('#newHeight');
                if (!activeToolArea.querySelector('#aspectRatio').checked) return;
                if (changedInput === 'width') heightInput.value = Math.round(parseInt(widthInput.value, 10) / originalImageRatio);
                else widthInput.value = Math.round(parseInt(heightInput.value, 10) * originalImageRatio);
            }

            async function handleResizeImage() {
                const fileInput = activeToolArea.querySelector('#resizeFile');
                const newWidth = parseInt(activeToolArea.querySelector('#newWidth').value);
                const newHeight = parseInt(activeToolArea.querySelector('#newHeight').value);
                const outputDiv = activeToolArea.querySelector('#resize-output');
                if (fileInput.files.length === 0) { alert('Please select an image file.'); return; }
                if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) { alert('Please enter valid width and height.'); return; }
                showLoader(true);
                const file = fileInput.files[0];
                const image = await loadImage(URL.createObjectURL(file));
                const canvas = document.createElement('canvas');
                canvas.width = newWidth; canvas.height = newHeight;
                canvas.getContext('2d').drawImage(image, 0, 0, newWidth, newHeight);
                const url = canvas.toDataURL(file.type);
                createDownloadLink(url, `resized.${file.type.split('/')[1]}`, 'Download Resized Image', outputDiv);
                outputDiv.insertAdjacentHTML('beforeend', `<img src="${url}" class="max-w-full h-auto mt-4 rounded-lg shadow-md">`);
                showLoader(false);
            }

            // Apply common styles dynamically
            const style = document.createElement('style');
            style.textContent = `
                .file-input { display: block; width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color); border-radius: 0.5rem; margin-bottom: 1rem; cursor: pointer; background-color: var(--bg-primary); transition: border-color 0.2s; }
                .file-input:hover { border-color: var(--accent-color); }
                .action-btn { width: 100%; padding: 0.75rem; background-color: var(--accent-color); color: white; font-weight: 600; border-radius: 0.5rem; transition: background-color 0.2s; }
                .action-btn:hover { background-color: var(--accent-hover); }
                .output-area { margin-top: 1.5rem; padding: 1rem; background-color: var(--bg-primary); border-radius: 0.5rem; min-height: 50px; }
                .download-link { display: inline-block; padding: 0.75rem 1.5rem; background-color: #10b981; color: white; font-weight: 600; border-radius: 0.5rem; text-decoration: none; transition: background-color 0.2s; }
                .download-link:hover { background-color: #059669; }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>

