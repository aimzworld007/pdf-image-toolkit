<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF & Image Toolkit</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #f3f4f6; /* gray-100 */
            --bg-secondary: #ffffff; /* white */
            --text-primary: #111827; /* gray-900 */
            --text-secondary: #4b5563; /* gray-600 */
            --border-color: #e5e7eb; /* gray-200 */
            --accent-color: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
        }

        html.dark {
            --bg-primary: #111827; /* gray-900 */
            --bg-secondary: #1f2937; /* gray-800 */
            --text-primary: #f9fafb; /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --accent-color: #60a5fa; /* blue-400 */
            --accent-hover: #3b82f6; /* blue-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .tool-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        html.dark .tool-card:hover {
             box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -2px rgba(0,0,0,0.15);
        }

        /* Cropper.js specific dark mode styles */
        html.dark .cropper-view-box { outline-color: var(--accent-color); }
        html.dark .cropper-face, html.dark .cropper-line, html.dark .cropper-point { background-color: var(--accent-color); opacity: 1; }
        
        /* Style for range slider */
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--border-color); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent-color); cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--accent-color); cursor: pointer; border-radius: 50%; }

         /* Universal Drag and Drop Zone */
         .drop-zone {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2.5rem;
            border: 3px dashed var(--border-color);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .drop-zone.dragover {
            border-color: var(--accent-color);
            background-color: var(--bg-primary);
        }
        .drop-zone-icon {
            width: 3rem;
            height: 3rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        .drop-zone-text-main {
            font-weight: 600;
            color: var(--text-primary);
        }
         .drop-zone-text-sub {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl md:text-4xl font-extrabold">PDF & Image <span class="text-[var(--accent-color)]">Toolkit</span></h1>
                <p class="text-md text-[var(--text-secondary)] mt-1">Simple, powerful, and free tools for your files.</p>
            </div>
            <button id="theme-toggle" title="Toggle Theme" class="p-2 rounded-full hover:bg-[var(--border-color)] transition-colors">
                <svg id="theme-icon-light" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Tool Selection Grid (Visible by default) -->
            <div id="tool-selection">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div class="tool-card rounded-xl" data-tool="jpg-to-pdf"><div class="p-6"><h3 class="text-xl font-semibold">JPG to PDF</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Convert a JPG image to a PDF file.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="pdf-to-jpg"><div class="p-6"><h3 class="text-xl font-semibold">PDF to JPG</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Extract all pages of a PDF to JPG images.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="combine-pdfs"><div class="p-6"><h3 class="text-xl font-semibold">Combine PDFs & Images</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Merge PDFs and images into one PDF file.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="images-to-pdf"><div class="p-6"><h3 class="text-xl font-semibold">Images to PDF</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Combine multiple images into a single PDF.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="compress-jpg"><div class="p-6"><h3 class="text-xl font-semibold">Compress JPG</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Reduce the file size of a JPG image.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="resize-image"><div class="p-6"><h3 class="text-xl font-semibold">Resize Image</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Change the dimensions of an image.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="crop-image"><div class="p-6"><h3 class="text-xl font-semibold">Crop Image</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Cut and crop your images with ease.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="merge-images"><div class="p-6"><h3 class="text-xl font-semibold">Merge Images</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Join two images together.</p></div></div>
                    <div class="tool-card rounded-xl" data-tool="convert-image"><div class="p-6"><h3 class="text-xl font-semibold">Image Converter</h3><p class="text-sm text-[var(--text-secondary)] mt-1">Convert between JPG and PNG formats.</p></div></div>
                </div>
            </div>
            
            <!-- Active Tool Area (Hidden by default) -->
            <div id="active-tool-area" class="hidden"></div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-12 text-[var(--text-secondary)] text-sm">
            <p class="inline-flex items-center">Made With <svg class="w-5 h-5 mx-1 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg> By <a href="https://Ainulislam.info" target="_blank" rel="noopener noreferrer" class="font-semibold text-[var(--accent-color)] hover:underline ml-1">Ainul islam</a></p>
        </footer>

        <!-- Loading Spinner -->
        <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-400"></div>
                <p id="loader-text" class="text-white text-lg mt-4">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Universal Drop Zone Template -->
    <template id="template-drop-zone">
        <div class="drop-zone">
            <input type="file" class="hidden">
            <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" /></svg>
            <p class="drop-zone-text-main">Drag & Drop file(s) here</p>
            <p class="drop-zone-text-sub">or click to select</p>
            <p class="drop-zone-filename text-sm font-medium text-[var(--accent-color)] mt-2"></p>
        </div>
    </template>

    <!-- Tool Templates -->
    <template id="template-jpg-to-pdf"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">JPG to PDF</h2><div class="drop-zone-container"></div><button id="jpg-to-pdf-btn" class="action-btn">Convert to PDF</button><div class="output-area"></div></div></template>
    <template id="template-pdf-to-jpg"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">PDF to JPG</h2><div class="drop-zone-container"></div><button id="pdf-to-jpg-btn" class="action-btn">Convert to JPGs</button><p class="text-xs text-[var(--text-secondary)] text-center mt-2">Each page will be displayed below as a separate, downloadable image.</p><div class="output-area grid grid-cols-2 md:grid-cols-4 gap-4"></div></div></template>
    <template id="template-combine-pdfs"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Combine PDFs & Images</h2><p class="mb-4 text-[var(--text-secondary)]">Start by uploading files. Then add more, rearrange, and combine.</p><div id="combine-drop-zone" class="drop-zone-container"></div><div class="my-4 flex flex-wrap gap-4 items-center"><button id="add-more-files-btn" class="action-btn flex-1 hidden">+ Add More Files</button><button id="combine-all-btn" class="action-btn flex-1 bg-green-600 hover:bg-green-700 hidden">Combine All & Download</button></div><div id="combine-preview-list" class="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div><div class="output-area"></div></div></template>
    <template id="template-images-to-pdf"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Images to PDF</h2><div class="drop-zone-container"></div><button id="images-to-pdf-btn" class="action-btn">Combine to PDF</button><div id="image-preview-list" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4"></div><div class="output-area"></div></div></template>
    <template id="template-compress-jpg"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Compress JPG</h2><div class="drop-zone-container"></div><div class="my-4"><label for="qualitySlider" class="font-medium">Quality: <span id="qualityValue">0.8</span></label><input type="range" id="qualitySlider" min="0.1" max="1" step="0.1" value="0.8" class="w-full mt-2"></div><button id="compress-jpg-btn" class="action-btn">Compress & Download</button><div class="output-area"></div></div></template>
    <template id="template-resize-image"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Image Resizer</h2><div class="drop-zone-container"></div><div class="flex flex-wrap gap-4 my-4 items-center"><div><label for="newWidth" class="font-medium">Width:</label><input type="number" id="newWidth" placeholder="800" class="p-2 border rounded-md w-32 bg-[var(--bg-primary)] border-[var(--border-color)]"></div><div><label for="newHeight" class="font-medium">Height:</label><input type="number" id="newHeight" placeholder="600" class="p-2 border rounded-md w-32 bg-[var(--bg-primary)] border-[var(--border-color)]"></div><div class="flex items-center pt-5"><input type="checkbox" id="aspectRatio" class="h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)]" checked><label for="aspectRatio" class="ml-2">Maintain Aspect Ratio</label></div></div><button id="resize-btn" class="action-btn">Resize & Download</button><div class="output-area"></div></div></template>
    <template id="template-crop-image"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Image Cropper</h2><div class="drop-zone-container"></div><div class="flex flex-col md:flex-row gap-6 items-start mt-4"><div class="w-full md:w-2/3"><div class="img-container rounded-lg overflow-hidden"><img id="imageToCrop" style="display: block; max-width: 100%;"></div></div><div class="w-full md:w-1/3 flex flex-col items-center"><p class="font-medium mb-2">Preview</p><div id="crop-preview" class="w-[150px] h-[150px] overflow-hidden rounded-lg border-2 border-dashed border-[var(--border-color)]"></div></div></div><button id="crop-btn" class="action-btn mt-4">Crop & Download</button><div class="output-area mt-4"></div></div></template>
    <template id="template-merge-images"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Merge Images</h2><p class="mb-4 text-[var(--text-secondary)]">Drop two images to merge them.</p><div class="grid md:grid-cols-2 gap-4"><div class="drop-zone-container" data-input-id="img1"></div><div class="drop-zone-container" data-input-id="img2"></div></div><div class="flex items-center gap-4 my-4"><label class="font-medium">Merge Direction:</label><select id="mergeDirection" class="p-2 border rounded-md bg-[var(--bg-primary)] border-[var(--border-color)]"><option value="vertical">Vertical</option><option value="horizontal">Horizontal</option></select></div><button id="merge-btn" class="action-btn">Merge Images</button><div class="output-area"></div></div></template>
    <template id="template-convert-image"><div class="tool-content"><h2 class="text-2xl font-semibold mb-4">Image Converter</h2><div class="drop-zone-container"></div><div class="flex items-center gap-4 my-4"><label class="font-medium">Convert To:</label><select id="convertFormat" class="p-2 border rounded-md bg-[var(--bg-primary)] border-[var(--border-color)]"><option value="png">PNG</option><option value="jpeg">JPG</option></select></div><button id="convert-btn" class="action-btn">Convert Image</button><div class="output-area"></div></div></template>
    
    <script>
        // Set global worker for pdf.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const { PDFDocument } = PDFLib;

            // --- UI & THEME MANAGEMENT ---
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const html = document.documentElement;
            
            const toolSelection = document.getElementById('tool-selection');
            const activeToolArea = document.getElementById('active-tool-area');
            const loader = document.getElementById('loader');
            
            let cropper = null;
            let filesStore = new Map();

            // Theme switching logic
            const applyTheme = (isDark) => {
                html.classList.toggle('dark', isDark);
                lightIcon.classList.toggle('hidden', isDark);
                darkIcon.classList.toggle('hidden', !isDark);
            };

            themeToggle.addEventListener('click', () => {
                const isDark = !html.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                applyTheme(isDark);
            });
            
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme === 'dark' || (!savedTheme && systemPrefersDark));

            
            // --- NAVIGATION LOGIC ---
            function goHome() {
                activeToolArea.classList.add('hidden');
                activeToolArea.innerHTML = '';
                toolSelection.classList.remove('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }

            const switchTool = (toolId) => {
                filesStore.clear();
                toolSelection.classList.add('hidden');
                activeToolArea.classList.remove('hidden');
                
                const template = document.getElementById(`template-${toolId}`);
                if (!template) {
                    goHome();
                    return;
                }

                const toolContent = template.content.cloneNode(true);
                activeToolArea.innerHTML = ''; 

                const backButton = document.createElement('button');
                backButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg> Back to Tools`;
                backButton.className = 'mb-6 flex items-center font-semibold text-[var(--text-secondary)] hover:text-[var(--accent-color)] transition-colors';
                backButton.onclick = goHome;

                activeToolArea.appendChild(backButton);
                activeToolArea.appendChild(toolContent);
                
                addToolEventListeners(toolId);
            };

            document.querySelectorAll('.tool-card').forEach(card => {
                card.addEventListener('click', () => switchTool(card.dataset.tool));
            });
            
            // --- UTILITY FUNCTIONS ---
            const showLoader = (show, text = 'Processing...') => { 
                document.getElementById('loader-text').textContent = text;
                loader.style.display = show ? 'flex' : 'none'; 
            };

            const generateRandomFilename = (base, extension) => {
                const randomNumber = Math.floor(1000 + Math.random() * 9000);
                return `${base}_${randomNumber}.${extension}`;
            };
            
            const createDownloadLink = (href, download, text, targetElement) => {
                targetElement.innerHTML = ''; 
                const a = document.createElement('a');
                a.href = href;
                a.download = download;
                a.textContent = text;
                a.className = 'download-link';
                targetElement.appendChild(a);
            };
            
            const loadImage = (src) => new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });

            // --- DRAG AND DROP SETUP ---
            function setupDragAndDrop(container, inputId, isMultiple, acceptedTypes, fileHandler) {
                const dropZoneTemplate = document.getElementById('template-drop-zone').content.cloneNode(true);
                const dropZone = dropZoneTemplate.querySelector('.drop-zone');
                const fileInput = dropZoneTemplate.querySelector('input[type="file"]');
                const fileNameDisplay = dropZone.querySelector('.drop-zone-filename');

                fileInput.id = inputId;
                fileInput.multiple = isMultiple;
                fileInput.accept = acceptedTypes;
                
                container.appendChild(dropZone);

                const highlight = () => dropZone.classList.add('dragover');
                const unhighlight = () => dropZone.classList.remove('dragover');

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, highlight));
                ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, unhighlight));

                dropZone.addEventListener('drop', e => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    fileInput.files = files;
                    handleFiles(files);
                });

                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', e => handleFiles(e.target.files));

                function handleFiles(files) {
                    if (files.length > 0) {
                        filesStore.set(inputId, isMultiple ? Array.from(files) : files[0]);
                        fileNameDisplay.textContent = isMultiple ? `${files.length} file(s) selected` : files[0].name;
                        if (fileHandler) fileHandler(isMultiple ? Array.from(files) : files[0]);
                    }
                }
            }

            // --- EVENT LISTENERS ---
            function addToolEventListeners(toolId) {
                const getEl = (selector) => activeToolArea.querySelector(selector);
                const getDropContainer = (id) => getEl(`.drop-zone-container[data-input-id="${id}"]`) || getEl('.drop-zone-container');

                switch (toolId) {
                    case 'jpg-to-pdf': 
                        setupDragAndDrop(getDropContainer(), 'file', false, 'image/jpeg');
                        getEl('#jpg-to-pdf-btn').addEventListener('click', handleJpgToPdf); 
                        break;
                    case 'pdf-to-jpg': 
                        setupDragAndDrop(getDropContainer(), 'file', false, 'application/pdf');
                        getEl('#pdf-to-jpg-btn').addEventListener('click', handlePdfToJpg); 
                        break;
                    case 'combine-pdfs':
                        setupDragAndDrop(getEl('#combine-drop-zone'), 'files', true, 'application/pdf,image/jpeg,image/png', handleCombineFilePreviews);
                        getEl('#add-more-files-btn').addEventListener('click', () => {
                            const adder = document.createElement('input');
                            adder.type = 'file';
                            adder.multiple = true;
                            adder.accept = 'application/pdf,image/jpeg,image/png';
                            adder.onchange = (e) => {
                                const newFiles = Array.from(e.target.files);
                                const existingFiles = filesStore.get('files') || [];
                                const allFiles = [...existingFiles, ...newFiles];
                                filesStore.set('files', allFiles);
                                handleCombineFilePreviews(allFiles);
                            };
                            adder.click();
                        });
                        getEl('#combine-all-btn').addEventListener('click', handleCombineAllToPdf);
                        break;
                    case 'images-to-pdf': 
                        setupDragAndDrop(getDropContainer(), 'files', true, 'image/*', handleImagePreviews);
                        getEl('#images-to-pdf-btn').addEventListener('click', handleImagesToPdf); 
                        break;
                    case 'compress-jpg':
                        setupDragAndDrop(getDropContainer(), 'file', false, 'image/jpeg');
                        getEl('#qualitySlider').addEventListener('input', e => getEl('#qualityValue').textContent = e.target.value);
                        getEl('#compress-jpg-btn').addEventListener('click', handleCompressJpg);
                        break;
                    case 'resize-image': 
                        setupDragAndDrop(getDropContainer(), 'file', false, 'image/*', (file) => {
                            const reader = new FileReader();
                            reader.onload = e => {
                                const img = new Image();
                                img.onload = () => { getEl('#newWidth').value = img.width; getEl('#newHeight').value = img.height; filesStore.set('imageRatio', img.width / img.height); };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        });
                        getEl('#newWidth').addEventListener('input', () => handleAspectRatio('width'));
                        getEl('#newHeight').addEventListener('input', () => handleAspectRatio('height'));
                        getEl('#resize-btn').addEventListener('click', handleResizeImage); 
                        break;
                    case 'crop-image': 
                        setupDragAndDrop(getDropContainer(), 'file', false, 'image/*', (file) => handleCropFileChange(file));
                        getEl('#crop-btn').addEventListener('click', handleCropImage); 
                        break;
                     case 'merge-images': 
                        setupDragAndDrop(getDropContainer('img1'), 'img1', false, 'image/*');
                        setupDragAndDrop(getDropContainer('img2'), 'img2', false, 'image/*');
                        getEl('#merge-btn').addEventListener('click', handleMergeImages); 
                        break;
                    case 'convert-image': 
                        setupDragAndDrop(getDropContainer(), 'file', false, 'image/jpeg,image/png');
                        getEl('#convert-btn').addEventListener('click', handleConvertImage); 
                        break;
                }
            }
            
            // --- TOOL IMPLEMENTATIONS ---

            async function handleJpgToPdf() {
                const file = filesStore.get('file');
                if (!file) return alert('Please select a JPG file.');
                showLoader(true);
                try {
                    const jpgBytes = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.create();
                    const jpgImage = await pdfDoc.embedJpg(jpgBytes);
                    const page = pdfDoc.addPage([jpgImage.width, jpgImage.height]);
                    page.drawImage(jpgImage, { x: 0, y: 0, width: jpgImage.width, height: jpgImage.height });
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: "application/pdf" });
                    createDownloadLink(URL.createObjectURL(blob), generateRandomFilename('converted', 'pdf'), 'Download PDF', activeToolArea.querySelector('.output-area'));
                } catch(e) {
                    activeToolArea.querySelector('.output-area').innerHTML = `<p class="text-red-500">Error processing JPG.</p>`;
                } finally {
                    showLoader(false);
                }
            }

            async function handlePdfToJpg() {
                const file = filesStore.get('file');
                if (!file) return alert('Please select a PDF file.');
                showLoader(true, 'Reading PDF...');
                const outputDiv = activeToolArea.querySelector('.output-area');
                outputDiv.innerHTML = '';
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            showLoader(true, `Processing page ${i} of ${pdf.numPages}...`);
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = document.createElement('canvas');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                            const a = document.createElement('a');
                            a.href = canvas.toDataURL('image/jpeg');
                            a.download = generateRandomFilename(`page_${i}`, 'jpg');
                            a.innerHTML = `<img src="${a.href}" class="w-full h-auto object-cover rounded-lg shadow-md border border-[var(--border-color)]">`;
                            outputDiv.appendChild(a);
                        }
                    } catch (e) {
                        outputDiv.innerHTML = `<p class="text-red-500 col-span-full">Error: Could not process the PDF.</p>`;
                    } finally {
                        showLoader(false);
                    }
                };
                fileReader.readAsArrayBuffer(file);
            }
            
            let combinedFiles = [];
            function handleCombineFilePreviews(files) {
                const previewList = activeToolArea.querySelector('#combine-preview-list');
                const addBtn = activeToolArea.querySelector('#add-more-files-btn');
                const combineBtn = activeToolArea.querySelector('#combine-all-btn');
                
                addBtn.classList.remove('hidden');
                combineBtn.classList.remove('hidden');
                
                combinedFiles = files; // This now becomes the master list
                filesStore.set('files', combinedFiles);
                previewList.innerHTML = '';

                combinedFiles.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'relative p-1 border border-[var(--border-color)] rounded-lg shadow-sm cursor-move bg-[var(--bg-secondary)]';
                    div.draggable = true;
                    div.dataset.index = index;

                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'w-full h-24 flex items-center justify-center overflow-hidden';
                    
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.className = 'max-w-full max-h-full object-contain';
                        img.src = URL.createObjectURL(file);
                        contentWrapper.appendChild(img);
                    } else if (file.type === 'application/pdf') {
                        const canvas = document.createElement('canvas');
                        canvas.className = "max-w-full max-h-full object-contain";
                        contentWrapper.appendChild(canvas);
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                             const typedarray = new Uint8Array(e.target.result);
                             try {
                                const pdfjsDoc = await pdfjsLib.getDocument(typedarray).promise;
                                const pdfjsPage = await pdfjsDoc.getPage(1);
                                const viewport = pdfjsPage.getViewport({ scale: 0.3 });
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                await pdfjsPage.render({ canvasContext: context, viewport: viewport }).promise;
                             } catch (err) {
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = "var(--text-secondary)";
                                ctx.textAlign = "center";
                                ctx.font = "10px Inter";
                                ctx.fillText("Preview Error", canvas.width / 2, canvas.height / 2);
                             }
                        };
                        reader.readAsArrayBuffer(file);
                    }
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'absolute top-1 right-1 text-white bg-red-500/80 hover:bg-red-600 rounded-full w-5 h-5 flex items-center justify-center';
                    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
                    deleteBtn.onclick = () => {
                        combinedFiles.splice(index, 1);
                        handleCombineFilePreviews(combinedFiles); // Re-render
                    };

                    div.appendChild(contentWrapper);
                    div.appendChild(deleteBtn);
                    previewList.appendChild(div);
                });

                let draggedItem = null;
                previewList.addEventListener("dragstart", e => { draggedItem = e.target.closest("div[draggable]") });
                previewList.addEventListener("dragover", e => {
                    e.preventDefault();
                    const target = e.target.closest("div[draggable]");
                    if (target && target !== draggedItem) {
                        const rect = target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / rect.height > .5;
                        previewList.insertBefore(draggedItem, next && target.nextSibling || target);
                    }
                });
                previewList.addEventListener("drop", () => {
                    if (!draggedItem) return;
                    const newElements = [...previewList.children];
                    const newFileOrder = newElements.map(el => combinedFiles[parseInt(el.dataset.index)]);
                    handleCombineFilePreviews(newFileOrder);
                    draggedItem = null;
                });
            }

             async function handleCombineAllToPdf() {
                if (combinedFiles.length === 0) return alert('Please add at least one file.');
                showLoader(true, 'Combining files...');
                const outputArea = activeToolArea.querySelector('.output-area');
                try {
                    const finalPdf = await PDFDocument.create();
                    for (const file of combinedFiles) {
                         if (file.type === 'application/pdf') {
                            const pdfBytes = await file.arrayBuffer();
                            const pdfDoc = await PDFDocument.load(pdfBytes, { ignoreEncryption: true });
                            const copiedPages = await finalPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                            copiedPages.forEach(page => finalPdf.addPage(page));
                        } else if (file.type.startsWith('image/')) {
                            const bytes = await file.arrayBuffer();
                            let image;
                            if(file.type === 'image/jpeg') image = await finalPdf.embedJpg(bytes);
                            else image = await finalPdf.embedPng(bytes);
                            const page = finalPdf.addPage([image.width, image.height]);
                            page.drawImage(image, {x: 0, y: 0, width: image.width, height: image.height});
                        }
                    }
                    const mergedPdfBytes = await finalPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: "application/pdf" });
                    createDownloadLink(URL.createObjectURL(blob), generateRandomFilename("combined", "pdf"), "Download Combined PDF", outputArea);
                } catch(e) {
                    console.error(e);
                    outputArea.innerHTML = `<p class="text-red-500">An error occurred. One of the files might be corrupt or unsupported.</p>`;
                } finally {
                    showLoader(false);
                }
            }


            let imageFilesOrder = [];
            function handleImagePreviews(files) {
                const previewList = activeToolArea.querySelector('#image-preview-list');
                previewList.innerHTML = '';
                imageFilesOrder = files;
                filesStore.set('files', imageFilesOrder); // Update the store
                imageFilesOrder.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const div = document.createElement('div');
                        div.className = 'relative p-2 border border-[var(--border-color)] rounded-lg shadow-sm cursor-move bg-[var(--bg-secondary)]';
                        div.draggable = true;
                        div.dataset.originalIndex = index;
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded-md"><p class="text-xs truncate mt-1">${file.name}</p>`;
                        previewList.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
                let draggedItem = null;
                previewList.addEventListener("dragstart", e => { draggedItem = e.target.closest("div[draggable]") });
                previewList.addEventListener("dragover", e => {
                    e.preventDefault();
                    const target = e.target.closest("div[draggable]");
                    if (target && target !== draggedItem) {
                        const rect = target.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / rect.height > .5;
                        previewList.insertBefore(draggedItem, next && target.nextSibling || target);
                    }
                });
                previewList.addEventListener("drop", () => {
                    if (!draggedItem) return;
                    const newElements = [...previewList.children];
                    const originalFiles = filesStore.get('files');
                    const newFileOrder = newElements.map(el => originalFiles[parseInt(el.dataset.originalIndex)]);
                    imageFilesOrder = newFileOrder;
                    draggedItem = null;
                });
            }

            async function handleImagesToPdf() {
                const filesToProcess = imageFilesOrder.length > 0 ? imageFilesOrder : filesStore.get('files');
                if (!filesToProcess || filesToProcess.length === 0) return alert('Please select at least one image.');
                showLoader(true);
                const outputArea = activeToolArea.querySelector('.output-area');
                try {
                    const pdfDoc = await PDFDocument.create();
                    for (const file of filesToProcess) {
                        const bytes = await file.arrayBuffer();
                        let image;
                        if (file.type === 'image/jpeg') image = await pdfDoc.embedJpg(bytes);
                        else if (file.type === 'image/png') image = await pdfDoc.embedPng(bytes);
                        else continue;
                        const page = pdfDoc.addPage([image.width, image.height]);
                        page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
                    }
                    const pdfBytes = await pdfDoc.save();
                    createDownloadLink(URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" })), generateRandomFilename('images', 'pdf'), 'Download PDF', outputArea);
                } catch (e) {
                    console.error(e);
                    outputArea.innerHTML = `<p class="text-red-500">Error: Could not process images.</p>`;
                } finally {
                    showLoader(false);
                }
            }
            
            async function handleCompressJpg() {
                const file = filesStore.get('file');
                const quality = parseFloat(activeToolArea.querySelector('#qualitySlider').value);
                if (!file) return alert('Please select a JPG file.');
                showLoader(true);
                const outputArea = activeToolArea.querySelector('.output-area');
                try {
                    const image = await loadImage(URL.createObjectURL(file));
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    canvas.getContext('2d').drawImage(image, 0, 0);
                    const url = canvas.toDataURL('image/jpeg', quality);
                    outputArea.innerHTML = `<p class="text-center mb-4">Original size: ${ (file.size / 1024).toFixed(2) } KB. New size is approximately ${ (url.length * 0.75 / 1024).toFixed(2) } KB.</p>`;
                    createDownloadLink(url, generateRandomFilename('compressed', 'jpg'), `Download Compressed JPG`, outputArea);
                } catch(e) {
                    outputArea.innerHTML = `<p class="text-red-500">Error processing image.</p>`;
                } finally {
                     showLoader(false);
                }
            }

            async function handleResizeImage() {
                const file = filesStore.get("file");
                const newWidth = parseInt(activeToolArea.querySelector("#newWidth").value);
                const newHeight = parseInt(activeToolArea.querySelector("#newHeight").value);
                if (!file) { return alert("Please select an image file."); }
                if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) { return alert("Please enter valid width and height."); }
                showLoader(true);
                const outputDiv = activeToolArea.querySelector(".output-area");
                try {
                    const image = await loadImage(URL.createObjectURL(file));
                    const canvas = document.createElement("canvas");
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    canvas.getContext("2d").drawImage(image, 0, 0, newWidth, newHeight);
                    const url = canvas.toDataURL(file.type);
                    createDownloadLink(url, generateRandomFilename('resized', file.type.split("/")[1]), "Download Resized Image", outputDiv);
                    outputDiv.insertAdjacentHTML("beforeend", `<img src="${url}" class="max-w-full h-auto mt-4 rounded-lg shadow-md">`);
                } catch(e) {
                    outputDiv.innerHTML = `<p class="text-red-500">Error resizing image.</p>`;
                } finally {
                    showLoader(false);
                }
            }
            
            function handleAspectRatio(changedInput) {
                const widthInput = activeToolArea.querySelector("#newWidth");
                const heightInput = activeToolArea.querySelector("#newHeight");
                const ratio = filesStore.get('imageRatio');
                if (!activeToolArea.querySelector("#aspectRatio").checked || !ratio) return;
                if (changedInput === 'width') heightInput.value = Math.round(parseInt(widthInput.value, 10) / ratio);
                else widthInput.value = Math.round(parseInt(heightInput.value, 10) * ratio);
            }

            function handleCropFileChange(file) {
                if (file) {
                    const reader = new FileReader;
                    reader.onload = (e => {
                        const imageElement = activeToolArea.querySelector("#imageToCrop");
                        imageElement.src = e.target.result;
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(imageElement, { aspectRatio: 1, viewMode: 1, preview: activeToolArea.querySelector("#crop-preview") });
                    });
                    reader.readAsDataURL(file);
                }
            }

            function handleCropImage() {
                if (!cropper) { return void alert("Please upload an image first."); }
                const outputArea = activeToolArea.querySelector('.output-area');
                cropper.getCroppedCanvas().toBlob((blob => {
                    const url = URL.createObjectURL(blob);
                    createDownloadLink(url, generateRandomFilename('cropped', 'png'), "Download Cropped Image", outputArea);
                }));
            }

            async function handleMergeImages() {
                const file1 = filesStore.get("img1");
                const file2 = filesStore.get("img2");
                const direction = activeToolArea.querySelector("#mergeDirection").value;
                if (!file1 || !file2) { return void alert("Please select two images."); }
                showLoader(true);
                const outputDiv = activeToolArea.querySelector('.output-area');
                try {
                    const [img1, img2] = await Promise.all([ loadImage(URL.createObjectURL(file1)), loadImage(URL.createObjectURL(file2)) ]);
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    if ("horizontal" === direction) {
                        canvas.width = img1.width + img2.width;
                        canvas.height = Math.max(img1.height, img2.height);
                        ctx.drawImage(img1, 0, 0);
                        ctx.drawImage(img2, img1.width, 0);
                    } else {
                        canvas.width = Math.max(img1.width, img2.width);
                        canvas.height = img1.height + img2.height;
                        ctx.drawImage(img1, 0, 0);
                        ctx.drawImage(img2, 0, img1.height);
                    }
                    const url = canvas.toDataURL("image/png");
                    outputDiv.innerHTML = `<p class="font-semibold mb-2">Preview:</p><img src="${url}" class="max-w-full h-auto rounded-lg shadow-md border border-[var(--border-color)] mb-4">`;
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = generateRandomFilename("merged", "png");
                    a.textContent = "Download Merged Image";
                    a.className = 'download-link';
                    outputDiv.appendChild(a);
                } catch(e) {
                     outputDiv.innerHTML = `<p class="text-red-500">Error merging images.</p>`;
                } finally {
                    showLoader(false);
                }
            }

            async function handleConvertImage() {
                const file = filesStore.get("file");
                const format = activeToolArea.querySelector("#convertFormat").value;
                if (!file) { return void alert("Please select an image file."); }
                showLoader(true);
                const outputArea = activeToolArea.querySelector('.output-area');
                try {
                    const image = await loadImage(URL.createObjectURL(file));
                    const canvas = document.createElement("canvas");
                    canvas.width = image.width;
                    canvas.height = image.height;
                    const ctx = canvas.getContext("2d");
                    if ("jpeg" === format) {
                        ctx.fillStyle = "#FFF";
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                    ctx.drawImage(image, 0, 0);
                    const mimeType = `image/${format}`;
                    createDownloadLink(canvas.toDataURL(mimeType), generateRandomFilename('converted', format), `Download as ${format.toUpperCase()}`, outputArea);
                } catch(e) {
                     outputArea.innerHTML = `<p class="text-red-500">Error converting image.</p>`;
                } finally {
                     showLoader(false);
                }
            }

            // Apply common styles dynamically
            const style = document.createElement('style');
            style.textContent = `.action-btn { display: block; width: 100%; padding: 0.75rem; background-color: var(--accent-color); color: white; font-weight: 600; border-radius: 0.5rem; transition: background-color 0.2s; margin-top: 1rem; } .action-btn:hover { background-color: var(--accent-hover); } .output-area { margin-top: 1.5rem; padding: 1rem; background-color: var(--bg-primary); border-radius: 0.5rem; min-height: 50px; } .download-link { display: inline-block; padding: 0.75rem 1.5rem; background-color: #10b981; color: white; font-weight: 600; border-radius: 0.5rem; text-decoration: none; transition: background-color 0.2s; } .download-link:hover { background-color: #059669; }`;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>

